<!DOCTYPE html>

<html lang="es" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>contenidos.views_cont &#8212; documentación de cmsweb - 0.1</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=def86cc0" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=86dffce3" />
    
    <script src="../../_static/documentation_options.js?v=9c9b61ad"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=d190bf04"></script>
    
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Índice de Módulos Python"
             >módulos</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">documentación de cmsweb - 0.1</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Código de módulo</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">contenidos.views_cont</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Código fuente para contenidos.views_cont</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.core.paginator</span> <span class="kn">import</span> <span class="n">Paginator</span>
<span class="kn">from</span> <span class="nn">django.core.serializers</span> <span class="kn">import</span> <span class="n">serialize</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span>  <span class="c1"># Para realizar búsquedas</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">Count</span><span class="p">,</span> <span class="n">DurationField</span><span class="p">,</span> <span class="n">ExpressionWrapper</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Sum</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.utils.dateparse</span> <span class="kn">import</span> <span class="n">parse_date</span>
<span class="kn">from</span> <span class="nn">django.utils.timezone</span> <span class="kn">import</span> <span class="n">make_aware</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span> <span class="nn">reportlab.lib.pagesizes</span> <span class="kn">import</span> <span class="n">letter</span>
<span class="kn">from</span> <span class="nn">reportlab.pdfgen</span> <span class="kn">import</span> <span class="n">canvas</span>

<span class="kn">from</span> <span class="nn">appcms.models</span> <span class="kn">import</span> <span class="n">Categoria</span>
<span class="kn">from</span> <span class="nn">appcms.utils.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">obtenerToken</span><span class="p">,</span>
    <span class="n">obtenerUserId</span><span class="p">,</span>
    <span class="n">obtenerUserInfoById</span><span class="p">,</span>
    <span class="n">obtenerUsersConRol</span><span class="p">,</span>
    <span class="n">tienePermiso</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">contenidos.models_cont</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Categoria</span><span class="p">,</span>
    <span class="n">Comentario</span><span class="p">,</span>
    <span class="n">ComentarioRoles</span><span class="p">,</span>
    <span class="n">Contenido</span><span class="p">,</span>
    <span class="n">Visualizacion</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">contenidos.notificacion</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">subcategorias.models</span> <span class="kn">import</span> <span class="n">Subcategoria</span>


<div class="viewcode-block" id="crear_contenido">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.crear_contenido">[documentos]</a>
<span class="k">def</span> <span class="nf">crear_contenido</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;comneta</span>
<span class="sd">    Crea un nuevo contenido en el sistema a partir de los datos enviados a través del formulario.</span>

<span class="sd">    :param request: Objeto HttpRequest que contiene los datos de la solicitud.</span>
<span class="sd">    :return: Si la solicitud es POST y los datos son válidos, redirige a &#39;lista_contenidos&#39;.</span>
<span class="sd">             Si hay errores, renderiza el formulario con mensajes de error.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">editores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span>
        <span class="s2">&quot;Editor&quot;</span>
    <span class="p">)</span>  <span class="c1"># Obtener todos los usuarios con el rol de Editor</span>
    <span class="n">categorias</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Categoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="p">)</span>  <span class="c1"># Obtener todas las categorías para mostrarlas en el formulario</span>
    <span class="n">subcategorias</span> <span class="o">=</span> <span class="n">Subcategoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># Obtener todas las subcategorías</span>
    <span class="n">sub_json</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">subcategorias</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># Obtener datos del formulario</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># O puedes decidir usar un valor predeterminado</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
        <span class="n">categoria</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categoria&quot;</span><span class="p">)</span>
        <span class="n">subcategoria</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subcategoria&quot;</span><span class="p">)</span>
        <span class="n">editor_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;editor&quot;</span><span class="p">)</span>

        <span class="c1"># Obtener el usuario actual como el autor</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">obtenerToken</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">autor_id</span> <span class="o">=</span> <span class="n">obtenerUserId</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="c1"># Obtener el publicador</span>
        <span class="n">publicador</span> <span class="o">=</span> <span class="n">autor_id</span>  <span class="c1"># Temporalmente asigna el autor como publicador</span>

        <span class="c1"># Imprimir todos los datos para comprobar que son correctos</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------Datos del formulario-------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Título: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Contenido: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Imagen: </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Categoría: </span><span class="si">{</span><span class="n">categoria</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subcategoría: </span><span class="si">{</span><span class="n">subcategoria</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Editor: </span><span class="si">{</span><span class="n">editor_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Autor: </span><span class="si">{</span><span class="n">autor_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Publicador: </span><span class="si">{</span><span class="n">publicador</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Obtener la instancia del modelo Categoria con el id proporcionado</span>
        <span class="n">categoria_obj</span> <span class="o">=</span> <span class="n">Categoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id_categoria</span><span class="o">=</span><span class="n">categoria</span><span class="p">)</span>

        <span class="c1"># Obtener la instancia del modelo Subcategoria con el id proporcionado, si existe</span>
        <span class="n">subcategoria_obj</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Subcategoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id_subcategoria</span><span class="o">=</span><span class="n">subcategoria</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subcategoria</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># Crear y guardar el nuevo contenido</span>
        <span class="n">nuevo_contenido</span> <span class="o">=</span> <span class="n">Contenido</span><span class="p">(</span>
            <span class="n">titulo</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">texto</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="n">imagen</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
            <span class="n">categoria</span><span class="o">=</span><span class="n">categoria_obj</span><span class="p">,</span>
            <span class="n">subcategoria</span><span class="o">=</span><span class="n">subcategoria_obj</span><span class="p">,</span>
            <span class="n">publicador_id</span><span class="o">=</span><span class="n">publicador</span><span class="p">,</span>  <span class="c1"># Asigna el publicador automáticamente</span>
            <span class="n">estado</span><span class="o">=</span><span class="s2">&quot;Borrador&quot;</span><span class="p">,</span>  <span class="c1"># Estado inicial automático</span>
            <span class="n">editor_id</span><span class="o">=</span><span class="n">editor_id</span><span class="p">,</span>
            <span class="n">autor_id</span><span class="o">=</span><span class="n">autor_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Imprimir el nuevo contenido</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------Nuevo contenido-------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Título: </span><span class="si">{</span><span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">titulo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Texto: </span><span class="si">{</span><span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">texto</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Imagen: </span><span class="si">{</span><span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">imagen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Categoría: </span><span class="si">{</span><span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">categoria</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subcategoría: </span><span class="si">{</span><span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">subcategoria</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Publicador: </span><span class="si">{</span><span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">publicador_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estado: </span><span class="si">{</span><span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">estado</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Editor: </span><span class="si">{</span><span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">editor_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Autor: </span><span class="si">{</span><span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">autor_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">nuevo_contenido</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Redireccionar después de guardar</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;gestion_contenido&quot;</span><span class="p">)</span>

    <span class="n">contexto</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;editores&quot;</span><span class="p">:</span> <span class="n">editores</span><span class="p">,</span> <span class="s2">&quot;categorias&quot;</span><span class="p">:</span> <span class="n">categorias</span><span class="p">,</span> <span class="s2">&quot;sub_json&quot;</span><span class="p">:</span> <span class="n">sub_json</span><span class="p">}</span>
    <span class="c1"># Renderizar el formulario si la solicitud no es POST</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;crear_contenido.html&quot;</span><span class="p">,</span> <span class="n">contexto</span><span class="p">)</span></div>



<div class="viewcode-block" id="lista_contenidos">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.lista_contenidos">[documentos]</a>
<span class="k">def</span> <span class="nf">lista_contenidos</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Muestra una lista de todos los contenidos en el sistema.</span>

<span class="sd">    :param request: Objeto HttpRequest que contiene los datos de la solicitud.</span>
<span class="sd">    :return: Respuesta renderizada con la plantilla &#39;lista_contenidos.html&#39; y el contexto que incluye los contenidos.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Obtener todos los contenidos inicialmente</span>
    <span class="n">contenidos</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="c1"># Obtener todos los usuarios de los roles que pueden publicar contenido</span>
    <span class="n">autores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span><span class="s2">&quot;Autor&quot;</span><span class="p">)</span>
    <span class="n">editores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span><span class="s2">&quot;Editor&quot;</span><span class="p">)</span>
    <span class="n">administradores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span><span class="s2">&quot;Administrador&quot;</span><span class="p">)</span>
    <span class="n">publicadores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span><span class="s2">&quot;Publicador&quot;</span><span class="p">)</span>

    <span class="c1"># Obtener los parámetros del filtro desde la solicitud</span>
    <span class="n">orden</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orden&quot;</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">)</span>  <span class="c1"># Por defecto descendente</span>
    <span class="n">categoria_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categoria&quot;</span><span class="p">)</span>
    <span class="n">autor_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;autor&quot;</span><span class="p">)</span>
    <span class="n">busqueda</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;busqueda&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># juntar listas de objetos sin repetir</span>
    <span class="n">autores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">usuario</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="n">usuario</span>
            <span class="k">for</span> <span class="n">usuario</span> <span class="ow">in</span> <span class="n">autores</span> <span class="o">+</span> <span class="n">editores</span> <span class="o">+</span> <span class="n">administradores</span> <span class="o">+</span> <span class="n">publicadores</span>
        <span class="p">}</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Filtrar por categoría si se proporciona</span>
    <span class="k">if</span> <span class="n">categoria_id</span><span class="p">:</span>
        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">categoria_id</span><span class="o">=</span><span class="n">categoria_id</span><span class="p">)</span>

    <span class="c1"># Filtrar por autor si se proporciona</span>
    <span class="k">if</span> <span class="n">autor_id</span><span class="p">:</span>

        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">autor_id</span><span class="o">=</span><span class="n">autor_id</span><span class="p">)</span>

    <span class="c1"># Filtrar por búsqueda en el título o el contenido</span>
    <span class="k">if</span> <span class="n">busqueda</span><span class="p">:</span>
        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">titulo__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">texto__icontains</span><span class="o">=</span><span class="n">busqueda</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Ordenar por fecha de creación</span>
    <span class="k">if</span> <span class="n">orden</span> <span class="o">==</span> <span class="s2">&quot;asc&quot;</span><span class="p">:</span>
        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;fecha_modificacion&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-fecha_modificacion&quot;</span><span class="p">)</span>

    <span class="c1"># Pasar la lista de contenidos y categorías al contexto</span>
    <span class="n">categorias</span> <span class="o">=</span> <span class="n">Categoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">paginator</span> <span class="o">=</span> <span class="n">Paginator</span><span class="p">(</span><span class="n">contenidos</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10 contenidos por página</span>
    <span class="n">page_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page&quot;</span><span class="p">)</span>
    <span class="n">page_obj</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">get_page</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>

    <span class="n">contexto</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;page_obj&quot;</span><span class="p">:</span> <span class="n">page_obj</span><span class="p">,</span>
        <span class="s2">&quot;contenidos&quot;</span><span class="p">:</span> <span class="n">contenidos</span><span class="p">,</span>
        <span class="s2">&quot;categorias&quot;</span><span class="p">:</span> <span class="n">categorias</span><span class="p">,</span>
        <span class="s2">&quot;busqueda&quot;</span><span class="p">:</span> <span class="n">busqueda</span><span class="p">,</span>
        <span class="s2">&quot;autores&quot;</span><span class="p">:</span> <span class="n">autores</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;lista_contenidos.html&quot;</span><span class="p">,</span> <span class="n">contexto</span><span class="p">)</span></div>



<div class="viewcode-block" id="gestion_contenido">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.gestion_contenido">[documentos]</a>
<span class="k">def</span> <span class="nf">gestion_contenido</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Muestra la página de gestión de contenidos, que incluye todos los contenidos disponibles.</span>

<span class="sd">    :param request: Objeto HttpRequest que contiene los datos de la solicitud.</span>
<span class="sd">    :return: Respuesta renderizada con la plantilla &#39;gestion_contenido.html&#39; y el contexto que incluye los contenidos.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contenidos</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;gestion_contenido.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;contenidos&quot;</span><span class="p">:</span> <span class="n">contenidos</span><span class="p">})</span></div>



<span class="k">def</span> <span class="nf">editar_contenido</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Muestra la página para editar un contenido específico.</span>

<span class="sd">    :param request: Objeto HttpRequest que contiene los datos de la solicitud.</span>
<span class="sd">    :return: Respuesta renderizada con la plantilla &#39;editar_contenido.html&#39;.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Falta codigo para editar contenido</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;editar_contenido.html&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">eliminar_contenido</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Muestra la página para eliminar un contenido específico.</span>

<span class="sd">    :param request: Objeto HttpRequest que contiene los datos de la solicitud.</span>
<span class="sd">    :return: Respuesta renderizada con la plantilla &#39;eliminar_contenido.html&#39;.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Falta codigo para eliminar contenido</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;eliminar_contenido.html&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="upload_image">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.upload_image">[documentos]</a>
<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">upload_image</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sube una imagen al servidor y retorna su URL.</span>

<span class="sd">    :param request: Objeto HttpRequest que contiene los datos de la solicitud.</span>
<span class="sd">    :return: Un JsonResponse con la URL de la imagen subida.</span>
<span class="sd">    :rtype: JsonResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
        <span class="c1"># Guardar la imagen en el servidor</span>
        <span class="n">image_url</span> <span class="o">=</span> <span class="s2">&quot;ruta/donde/guardas/la/imagen/&quot;</span> <span class="o">+</span> <span class="n">image</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Retornar la URL de la imagen</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">image_url</span><span class="p">})</span></div>



<div class="viewcode-block" id="eliminar_contenido">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.eliminar_contenido">[documentos]</a>
<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">eliminar_contenido</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Elimina un objeto de tipo Contenido basado en su clave primaria (pk).</span>

<span class="sd">    :param request: El objeto de solicitud HTTP.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: Clave primaria del contenido que se desea eliminar.</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :return: Redirige a la vista de gestión de contenidos si la eliminación es exitosa,</span>
<span class="sd">             o retorna una respuesta JSON con un error si el contenido no existe.</span>
<span class="sd">    :rtype: HttpResponse or JsonResponse</span>

<span class="sd">    Si el contenido con la clave primaria proporcionada no se encuentra en la</span>
<span class="sd">    base de datos, se retorna un JSON con un mensaje de error y un estado HTTP 404.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">contenido</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">notificar_borrar_contenido</span><span class="p">(</span><span class="n">contenido</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;gestion_contenido&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Contenido no encontrado&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span></div>



<div class="viewcode-block" id="editar_contenido">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.editar_contenido">[documentos]</a>
<span class="k">def</span> <span class="nf">editar_contenido</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Edita un objeto de tipo Contenido basado en su clave primaria (pk).</span>

<span class="sd">    :param request: El objeto de solicitud HTTP.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: Clave primaria del contenido que se desea editar.</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :return: Redirige a la vista de gestión de contenidos después de guardar los cambios,</span>
<span class="sd">             o renderiza el formulario de edición con los datos actuales del contenido.</span>
<span class="sd">    :rtype: HttpResponse</span>

<span class="sd">    La función permite editar el título, texto, imagen, categoría, subcategoría,</span>
<span class="sd">    y editor de un contenido. Si no se proporciona una nueva imagen o texto,</span>
<span class="sd">    se mantendrán los valores originales.</span>

<span class="sd">    En caso de que se envíe una solicitud POST con los nuevos datos, estos se</span>
<span class="sd">    validan y el contenido se actualiza en la base de datos. El autor del</span>
<span class="sd">    contenido se obtiene utilizando un token a través de la función `obtenerToken`.</span>

<span class="sd">    **Contexto de la plantilla:**</span>

<span class="sd">    - ``contenido``: El contenido actual a editar.</span>
<span class="sd">    - ``editores``: Lista de usuarios con el rol de &quot;Editor&quot;.</span>
<span class="sd">    - ``categorias``: Lista de todas las categorías disponibles.</span>
<span class="sd">    - ``sub_json``: Subcategorías serializadas en formato JSON.</span>

<span class="sd">    :raises Http404: Si no se encuentra un contenido con la clave primaria proporcionada.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">contenido</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span>
        <span class="n">Contenido</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pk</span>
    <span class="p">)</span>  <span class="c1"># Obtener el contenido por ID o lanzar un error 404</span>
    <span class="n">editores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span><span class="s2">&quot;Editor&quot;</span><span class="p">)</span>  <span class="c1"># Obtener los usuarios con el rol &#39;Editor&#39;</span>
    <span class="n">categorias</span> <span class="o">=</span> <span class="n">Categoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># Obtener todas las categorías</span>
    <span class="n">subcategorias</span> <span class="o">=</span> <span class="n">Subcategoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># Obtener todas las subcategorías</span>
    <span class="n">sub_json</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">subcategorias</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># Obtener datos del formulario</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
        <span class="n">categoria</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categoria&quot;</span><span class="p">)</span>
        <span class="n">subcategoria</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subcategoria&quot;</span><span class="p">)</span>
        <span class="n">editor_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;editor&quot;</span><span class="p">)</span>

        <span class="c1"># Validar y limpiar el contenido</span>
        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">contenido</span><span class="o">.</span><span class="n">texto</span>
            <span class="p">)</span>  <span class="c1"># Mantener el contenido original si no se proporciona uno nuevo</span>

        <span class="c1"># Obtener el usuario actual como el autor</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">obtenerToken</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">autor_id</span> <span class="o">=</span> <span class="n">obtenerUserId</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="c1"># Obtener la categoría y subcategoría</span>
        <span class="n">categoria_obj</span> <span class="o">=</span> <span class="n">Categoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id_categoria</span><span class="o">=</span><span class="n">categoria</span><span class="p">)</span>
        <span class="n">subcategoria_obj</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Subcategoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id_subcategoria</span><span class="o">=</span><span class="n">subcategoria</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subcategoria</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># Actualizar el contenido con los nuevos datos</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">titulo</span> <span class="o">=</span> <span class="n">title</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">texto</span> <span class="o">=</span> <span class="n">content</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">imagen</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">image</span> <span class="k">if</span> <span class="n">image</span> <span class="k">else</span> <span class="n">contenido</span><span class="o">.</span><span class="n">imagen</span>
        <span class="p">)</span>  <span class="c1"># Mantener la imagen original si no se sube una nueva</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">categoria</span> <span class="o">=</span> <span class="n">categoria_obj</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">subcategoria</span> <span class="o">=</span> <span class="n">subcategoria_obj</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">editor_id</span> <span class="o">=</span> <span class="n">editor_id</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">autor_id</span> <span class="o">=</span> <span class="n">autor_id</span>  <span class="c1"># Mantener el autor actual</span>

        <span class="c1"># Guardar los cambios en el contenido</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">notificar_edicion_contenido</span><span class="p">(</span><span class="n">contenido</span><span class="p">)</span>
        <span class="c1"># Redireccionar a la lista de contenidos después de guardar</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;gestion_contenido&quot;</span><span class="p">)</span>

    <span class="n">contexto</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;contenido&quot;</span><span class="p">:</span> <span class="n">contenido</span><span class="p">,</span>
        <span class="s2">&quot;editores&quot;</span><span class="p">:</span> <span class="n">editores</span><span class="p">,</span>
        <span class="s2">&quot;categorias&quot;</span><span class="p">:</span> <span class="n">categorias</span><span class="p">,</span>
        <span class="s2">&quot;sub_json&quot;</span><span class="p">:</span> <span class="n">sub_json</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Renderizar el formulario de edición con los datos actuales del contenido</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;editar_contenido.html&quot;</span><span class="p">,</span> <span class="n">contexto</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">filtrar</span><span class="p">(</span><span class="n">lista</span><span class="p">,</span> <span class="n">rol</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filtra una lista de contenidos según el rol del usuario y su identificador.</span>

<span class="sd">    :param lista: Lista de objetos de contenido a filtrar.</span>
<span class="sd">    :type lista: list</span>
<span class="sd">    :param rol: Rol del usuario, que determina el criterio de filtrado. Puede ser uno de los siguientes: &quot;Autor&quot;, &quot;Editor&quot;, &quot;Publicador&quot; o &quot;Administrador&quot;.</span>
<span class="sd">    :type rol: str</span>
<span class="sd">    :param id: Identificador del usuario que se usará para el filtrado en caso de roles específicos.</span>
<span class="sd">    :type id: int</span>
<span class="sd">    :return: Lista de objetos de contenido filtrados según el rol y el identificador del usuario.</span>
<span class="sd">    :rtype: list</span>

<span class="sd">    **Roles:**</span>

<span class="sd">    - *Autor*: Incluye solo contenidos cuyo `autor_id` coincida con el `id` proporcionado.</span>
<span class="sd">    - *Editor*: Incluye solo contenidos cuyo `editor_id` coincida con el `id` proporcionado.</span>
<span class="sd">    - *Publicador* y *Administrador*: Incluyen todos los contenidos de la lista sin filtrado adicional.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nuevo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">rol</span> <span class="o">==</span> <span class="s2">&quot;Autor&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">contenido</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contenido</span><span class="o">.</span><span class="n">autor_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                <span class="n">nuevo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">contenido</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rol</span> <span class="o">==</span> <span class="s2">&quot;Editor&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">contenido</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contenido</span><span class="o">.</span><span class="n">editor_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                <span class="n">nuevo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">contenido</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rol</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Publicador&quot;</span><span class="p">,</span> <span class="s2">&quot;Administrador&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">contenido</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
            <span class="n">nuevo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">contenido</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">nuevo</span>


<div class="viewcode-block" id="filtrar">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.filtrar">[documentos]</a>
<span class="k">def</span> <span class="nf">filtrar</span><span class="p">(</span><span class="n">lista</span><span class="p">,</span> <span class="n">rol</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filtra una lista de contenidos según el rol del usuario y su identificador.</span>

<span class="sd">    :param lista: Lista de objetos de contenido a filtrar.</span>
<span class="sd">    :type lista: list</span>
<span class="sd">    :param rol: Rol del usuario, que determina el criterio de filtrado. Puede ser uno de los siguientes: &quot;Autor&quot;, &quot;Editor&quot;, &quot;Publicador&quot; o &quot;Administrador&quot;.</span>
<span class="sd">    :type rol: str</span>
<span class="sd">    :param id: Identificador del usuario que se usará para el filtrado en caso de roles específicos.</span>
<span class="sd">    :type id: int</span>
<span class="sd">    :return: Lista de objetos de contenido filtrados según el rol y el identificador del usuario.</span>
<span class="sd">    :rtype: list</span>

<span class="sd">    **Roles:**</span>

<span class="sd">    - *Autor*: Incluye solo contenidos cuyo `autor_id` coincida con el `id` proporcionado.</span>
<span class="sd">    - *Editor*: Incluye solo contenidos cuyo `editor_id` coincida con el `id` proporcionado.</span>
<span class="sd">    - *Publicador* y *Administrador*: Incluyen todos los contenidos de la lista sin filtrado adicional.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nuevo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">rol</span> <span class="o">==</span> <span class="s2">&quot;Autor&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">contenido</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contenido</span><span class="o">.</span><span class="n">autor_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                <span class="n">nuevo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">contenido</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rol</span> <span class="o">==</span> <span class="s2">&quot;Editor&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">contenido</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contenido</span><span class="o">.</span><span class="n">editor_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                <span class="n">nuevo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">contenido</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rol</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Publicador&quot;</span><span class="p">,</span> <span class="s2">&quot;Administrador&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">contenido</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
            <span class="n">nuevo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">contenido</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">nuevo</span></div>



<div class="viewcode-block" id="tablero_kanban">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.tablero_kanban">[documentos]</a>
<span class="k">def</span> <span class="nf">tablero_kanban</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renderiza el tablero kanban mostrando los contenidos filtrados por estado.</span>

<span class="sd">    :param request: El objeto de solicitud HTTP.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :return: Renderiza la plantilla &quot;tablero_kanban.html&quot; con el contexto de los</span>
<span class="sd">             contenidos filtrados por estado.</span>
<span class="sd">    :rtype: HttpResponse</span>

<span class="sd">    Los estados de los contenidos que se filtran y muestran en el tablero son:</span>

<span class="sd">    - &quot;Borrador&quot;</span>
<span class="sd">    - &quot;Revisión&quot;</span>
<span class="sd">    - &quot;A Publicar&quot;</span>
<span class="sd">    - &quot;Publicado&quot;</span>
<span class="sd">    - &quot;Inactivo&quot;</span>

<span class="sd">    En el contexto de la plantilla se incluyen las listas de contenidos por</span>
<span class="sd">    cada estado, de la siguiente manera:</span>

<span class="sd">    - ``borrador``: Contenidos en estado &quot;Borrador&quot;.</span>
<span class="sd">    - ``en_revision``: Contenidos en estado &quot;Revisión&quot;.</span>
<span class="sd">    - ``a_publicar``: Contenidos en estado &quot;A Publicar&quot;.</span>
<span class="sd">    - ``publicado``: Contenidos en estado &quot;Publicado&quot;.</span>
<span class="sd">    - ``inactivo``: Contenidos en estado &quot;Inactivo&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Obtener artículos filtrados por estado</span>
    <span class="n">borrador</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="s2">&quot;Borrador&quot;</span><span class="p">)</span>
    <span class="n">en_revision</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="s2">&quot;Revisión&quot;</span><span class="p">)</span>
    <span class="n">a_publicar</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="s2">&quot;A Publicar&quot;</span><span class="p">)</span>
    <span class="n">publicado</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="s2">&quot;Publicado&quot;</span><span class="p">)</span>
    <span class="n">inactivo</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="s2">&quot;Inactivo&quot;</span><span class="p">)</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">obtenerToken</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">obtenerUserId</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="n">users_autores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span><span class="s2">&quot;Autor&quot;</span><span class="p">)</span>
    <span class="n">users_editores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span><span class="s2">&quot;Editor&quot;</span><span class="p">)</span>
    <span class="n">users_publicadores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span><span class="s2">&quot;Publicador&quot;</span><span class="p">)</span>
    <span class="n">users_administradores</span> <span class="o">=</span> <span class="n">obtenerUsersConRol</span><span class="p">(</span><span class="s2">&quot;Administrador&quot;</span><span class="p">)</span>
    <span class="n">rol</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_autores</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="n">rol</span> <span class="o">=</span> <span class="s2">&quot;Autor&quot;</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_editores</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="n">rol</span> <span class="o">=</span> <span class="s2">&quot;Editor&quot;</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_publicadores</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="n">rol</span> <span class="o">=</span> <span class="s2">&quot;Publicador&quot;</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_administradores</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="n">rol</span> <span class="o">=</span> <span class="s2">&quot;Administrador&quot;</span>
    <span class="n">borrador</span> <span class="o">=</span> <span class="n">filtrar</span><span class="p">(</span><span class="n">borrador</span><span class="p">,</span> <span class="n">rol</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">en_revision</span> <span class="o">=</span> <span class="n">filtrar</span><span class="p">(</span><span class="n">en_revision</span><span class="p">,</span> <span class="n">rol</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">a_publicar</span> <span class="o">=</span> <span class="n">filtrar</span><span class="p">(</span><span class="n">a_publicar</span><span class="p">,</span> <span class="n">rol</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">publicado</span> <span class="o">=</span> <span class="n">filtrar</span><span class="p">(</span><span class="n">publicado</span><span class="p">,</span> <span class="n">rol</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">inactivo</span> <span class="o">=</span> <span class="n">filtrar</span><span class="p">(</span><span class="n">inactivo</span><span class="p">,</span> <span class="n">rol</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

    <span class="n">contexto</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;borrador&quot;</span><span class="p">:</span> <span class="n">borrador</span><span class="p">,</span>
        <span class="s2">&quot;en_revision&quot;</span><span class="p">:</span> <span class="n">en_revision</span><span class="p">,</span>
        <span class="s2">&quot;a_publicar&quot;</span><span class="p">:</span> <span class="n">a_publicar</span><span class="p">,</span>
        <span class="s2">&quot;publicado&quot;</span><span class="p">:</span> <span class="n">publicado</span><span class="p">,</span>
        <span class="s2">&quot;inactivo&quot;</span><span class="p">:</span> <span class="n">inactivo</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;tablero_kanban.html&quot;</span><span class="p">,</span> <span class="n">contexto</span><span class="p">)</span></div>



<div class="viewcode-block" id="visualizar_contenido">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.visualizar_contenido">[documentos]</a>
<span class="k">def</span> <span class="nf">visualizar_contenido</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Despliega la informacion de un solo contenido y los comentarios para ese contenido</span>

<span class="sd">    :param request: La solicitud HTTP.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: La clave primaria del contenido a ser desplegado</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :return: HttpResponse: La respuesta renderizada con la lista de categorías.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">contenido</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="c1"># guarla el numero de visualizaciones</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">visualizaciones</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">Visualizacion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">contenido</span><span class="o">=</span><span class="n">contenido</span><span class="p">,</span> <span class="n">fecha</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="n">comentarios</span> <span class="o">=</span> <span class="n">Comentario</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">contenido</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">comentarios_roles</span> <span class="o">=</span> <span class="n">ComentarioRoles</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">contenido</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="c1"># Reemplazar el ID del usuario por su nombre de usuario en contenido</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">autor_id</span> <span class="o">=</span> <span class="n">obtenerUserInfoById</span><span class="p">(</span><span class="n">contenido</span><span class="o">.</span><span class="n">autor_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>

        <span class="c1"># Reemplazar el ID del usuario por su nombre de usuario en comentarios</span>
        <span class="k">for</span> <span class="n">comentario</span> <span class="ow">in</span> <span class="n">comentarios</span><span class="p">:</span>
            <span class="n">comentario</span><span class="o">.</span><span class="n">usuario</span> <span class="o">=</span> <span class="n">obtenerUserInfoById</span><span class="p">(</span><span class="n">comentario</span><span class="o">.</span><span class="n">usuario</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>

        <span class="c1"># Reemplazar el ID del usuario por su nombre de usuario en comentarios</span>
        <span class="k">for</span> <span class="n">comentario_</span> <span class="ow">in</span> <span class="n">comentarios_roles</span><span class="p">:</span>
            <span class="n">comentario_</span><span class="o">.</span><span class="n">usuario</span> <span class="o">=</span> <span class="n">obtenerUserInfoById</span><span class="p">(</span><span class="n">comentario_</span><span class="o">.</span><span class="n">usuario</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;username&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Reemplazar el ID del usuario por su nombre de usuario en comentarios</span>
        <span class="k">for</span> <span class="n">comentario_</span> <span class="ow">in</span> <span class="n">comentarios_roles</span><span class="p">:</span>
            <span class="n">comentario_</span><span class="o">.</span><span class="n">usuario</span> <span class="o">=</span> <span class="n">obtenerUserInfoById</span><span class="p">(</span><span class="n">comentario_</span><span class="o">.</span><span class="n">usuario</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;username&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;contenido.html&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;contenido&quot;</span><span class="p">:</span> <span class="n">contenido</span><span class="p">,</span>
                <span class="s2">&quot;comentarios&quot;</span><span class="p">:</span> <span class="n">comentarios</span><span class="p">,</span>
                <span class="s2">&quot;comentarios_roles&quot;</span><span class="p">:</span> <span class="n">comentarios_roles</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Contenido no encontrado&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span></div>



<div class="viewcode-block" id="cambiar_estado">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.cambiar_estado">[documentos]</a>
<span class="k">def</span> <span class="nf">cambiar_estado</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">estado_actual</span><span class="p">,</span> <span class="n">estado_siguiente</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cambia el estado de un objeto de tipo Contenido, siempre y cuando los</span>
<span class="sd">    estados actual y siguiente sean válidos y se puedan transitar entre ellos.</span>

<span class="sd">    :param request: El objeto de solicitud HTTP.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: Clave primaria del contenido que se va a actualizar.</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :param estado_actual: Estado actual del contenido.</span>
<span class="sd">    :type estado_actual: str</span>
<span class="sd">    :param estado_siguiente: Estado al cual se desea cambiar.</span>
<span class="sd">    :type estado_siguiente: str</span>
<span class="sd">    :return: Redirige a la página anterior o, si no existe, al tablero kanban.</span>
<span class="sd">    :rtype: HttpResponse</span>

<span class="sd">    Los estados disponibles son:</span>

<span class="sd">    - &quot;Borrador&quot;</span>
<span class="sd">    - &quot;Revisión&quot;</span>
<span class="sd">    - &quot;A Publicar&quot;</span>
<span class="sd">    - &quot;Publicado&quot;</span>
<span class="sd">    - &quot;Inactivo&quot;</span>

<span class="sd">    La función valida que los estados proporcionados sean válidos y permite</span>
<span class="sd">    cambios entre estados consecutivos, a excepción del estado &quot;Inactivo&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contenido</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Contenido</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="n">estados_disponibles</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Borrador&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Revisión&quot;</span><span class="p">,</span>
        <span class="s2">&quot;A Publicar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Publicado&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Inactivo&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">scopes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;enviar-borrador-revision&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enviar-revision-Apublicar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enviar-Apublicar-Publicado&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">scopes</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="s2">&quot;enviar-revision-borrador&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enviar-Apublicar-revision&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enviar-Publicado-Apublicar&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">obtenerToken</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">permiso</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s2">&quot;Borrador&quot;</span><span class="p">,</span> <span class="s2">&quot;Revisión&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-borrador-revision&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;Revisión&quot;</span><span class="p">,</span> <span class="s2">&quot;A Publicar&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-revision-Apublicar&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;A Publicar&quot;</span><span class="p">,</span> <span class="s2">&quot;Publicado&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-Apublicar-Publicado&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;Revisión&quot;</span><span class="p">,</span> <span class="s2">&quot;Borrador&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-revision-borrador&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;A Publicar&quot;</span><span class="p">,</span> <span class="s2">&quot;Revisión&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-Apublicar-revision&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;Publicado&quot;</span><span class="p">,</span> <span class="s2">&quot;A Publicar&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-Publicado-Apublicar&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">scopes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;enviar-borrador-revision&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enviar-revision-Apublicar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enviar-Apublicar-Publicado&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">scopes</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="s2">&quot;enviar-revision-borrador&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enviar-Apublicar-revision&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enviar-Publicado-Apublicar&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">obtenerToken</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">permiso</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s2">&quot;Borrador&quot;</span><span class="p">,</span> <span class="s2">&quot;Revisión&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-borrador-revision&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;Revisión&quot;</span><span class="p">,</span> <span class="s2">&quot;A Publicar&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-revision-Apublicar&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;A Publicar&quot;</span><span class="p">,</span> <span class="s2">&quot;Publicado&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-Apublicar-Publicado&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;Revisión&quot;</span><span class="p">,</span> <span class="s2">&quot;Borrador&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-revision-borrador&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;A Publicar&quot;</span><span class="p">,</span> <span class="s2">&quot;Revisión&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-Apublicar-revision&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;Publicado&quot;</span><span class="p">,</span> <span class="s2">&quot;A Publicar&quot;</span><span class="p">):</span> <span class="s2">&quot;enviar-Publicado-Apublicar&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Verifica que los estados actual y siguiente existan en la lista de estados</span>
    <span class="k">if</span> <span class="n">estado_actual</span> <span class="ow">in</span> <span class="n">estados_disponibles</span> <span class="ow">and</span> <span class="n">estado_siguiente</span> <span class="ow">in</span> <span class="n">estados_disponibles</span><span class="p">:</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">estados_disponibles</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">estado_actual</span><span class="p">)</span>
        <span class="n">siguiente</span> <span class="o">=</span> <span class="n">estados_disponibles</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">estado_siguiente</span><span class="p">)</span>

        <span class="c1"># Si el estado siguiente no es &#39;Inactivo&#39; y el estado actual no es &#39;Publicado&#39;</span>
        <span class="k">if</span> <span class="n">estado_siguiente</span> <span class="o">!=</span> <span class="s2">&quot;Inactivo&quot;</span> <span class="ow">and</span> <span class="n">estado_actual</span> <span class="o">!=</span> <span class="s2">&quot;Inactivo&quot;</span><span class="p">:</span>
            <span class="c1"># Verifica que los estados estén uno al lado del otro</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">siguiente</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">estado_actual</span> <span class="o">==</span> <span class="s2">&quot;Inactivo&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tienePermiso</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;contenido&quot;</span><span class="p">,</span> <span class="n">scopes</span><span class="p">)[</span>
                    <span class="n">permiso</span><span class="p">[(</span><span class="n">estado_actual</span><span class="p">,</span> <span class="n">estado_siguiente</span><span class="p">)]</span>
                <span class="p">]:</span>
                    <span class="n">contenido</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="n">estado_siguiente</span>
                    <span class="n">contenido</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="n">enviar_notificacion_cambio_estado</span><span class="p">(</span><span class="n">estado_siguiente</span><span class="p">,</span> <span class="n">contenido</span><span class="p">)</span>
                    <span class="c1"># messages.success(request, &quot;El estado ha sido cambiado exitosamente.&quot;)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="n">request</span><span class="p">,</span>
                        <span class="s2">&quot;No posee los permisos necesarios para cambiar a ese estado&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span>
                    <span class="s2">&quot;Error. Se debe respetar el flujo de estados de los contenidos&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">contenido</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="n">estado_siguiente</span>
            <span class="n">contenido</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">enviar_notificacion_cambio_estado</span><span class="p">(</span><span class="n">estado_siguiente</span><span class="p">,</span> <span class="n">contenido</span><span class="p">)</span>
            <span class="c1"># messages.success(request, &quot;El contenido ha sido inactivado.&quot;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Error. Estados proporcionados invalidos&quot;</span><span class="p">)</span>

    <span class="c1"># Manejar la redirección si HTTP_REFERER no está presente</span>
    <span class="n">referer</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_REFERER&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">referer</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">referer</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Si no hay referer, redirigir a una vista por defecto</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;tablero_kanban&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="guardar_comentario">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.guardar_comentario">[documentos]</a>
<span class="k">def</span> <span class="nf">guardar_comentario</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Guarda un comentario en un objeto de tipo Contenido.</span>

<span class="sd">    :param request: El objeto de solicitud HTTP.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: Clave primaria del contenido al que se le va a añadir un comentario.</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :return: Redirige a la página de visualización del contenido.</span>
<span class="sd">    :rtype: HttpResponse</span>

<span class="sd">    Si el método HTTP es POST, la función busca un comentario en los datos de</span>
<span class="sd">    la solicitud, lo limpia de etiquetas HTML, y lo guarda asociado al</span>
<span class="sd">    contenido correspondiente. En caso de no proporcionar un comentario válido,</span>
<span class="sd">    se gestiona un mensaje de error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contenido_</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Contenido</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>

        <span class="c1"># Si se esta realizando prubeas unitarias, se asigna un usuario por defecto</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">TESTING</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;autor1&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#  Guardar el id del usuario logeado</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">obtenerUserId</span><span class="p">(</span><span class="n">obtenerToken</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>

        <span class="n">comentario_</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comentario&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comentario_</span><span class="p">:</span>
            <span class="n">comentario_</span> <span class="o">=</span> <span class="n">comentario_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">nuevo_comentario</span> <span class="o">=</span> <span class="n">Comentario</span><span class="p">(</span>
                <span class="n">contenido</span><span class="o">=</span><span class="n">contenido_</span><span class="p">,</span>
                <span class="n">comentario</span><span class="o">=</span><span class="n">comentario_</span><span class="p">,</span>
                <span class="n">usuario</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">nuevo_comentario</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;El comentario no puede estar vacío.&quot;</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;visualizar_contenido&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span></div>



<div class="viewcode-block" id="guardar_comentario_Roles">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.guardar_comentario_Roles">[documentos]</a>
<span class="k">def</span> <span class="nf">guardar_comentario_Roles</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Guarda un comentario desde revision, en un objeto de tipo Contenido.</span>

<span class="sd">    :param request: El objeto de solicitud HTTP.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: Clave primaria del contenido al que se le va a añadir un comentario.</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :return: Redirige a la página de visualización del contenido.</span>
<span class="sd">    :rtype: HttpResponse</span>

<span class="sd">    Si el método HTTP es POST, la función busca un comentario en los datos de</span>
<span class="sd">    la solicitud, lo limpia de etiquetas HTML, y lo guarda asociado al</span>
<span class="sd">    contenido correspondiente. En caso de no proporcionar un comentario válido,</span>
<span class="sd">    se gestiona un mensaje de error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contenido_</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Contenido</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">comentario_</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comentario_rol&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comentario_</span><span class="p">:</span>
            <span class="n">comentario_</span> <span class="o">=</span> <span class="n">comentario_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">nuevo_comentario</span> <span class="o">=</span> <span class="n">ComentarioRoles</span><span class="p">(</span>
                <span class="n">contenido</span><span class="o">=</span><span class="n">contenido_</span><span class="p">,</span>
                <span class="n">comentario</span><span class="o">=</span><span class="n">comentario_</span><span class="p">,</span>
                <span class="n">usuario</span><span class="o">=</span><span class="n">obtenerUserId</span><span class="p">(</span>
                    <span class="n">obtenerToken</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                <span class="p">),</span>  <span class="c1"># Guardar el id del usuario logeado</span>
                <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">nuevo_comentario</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">cambiar_estado</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="s2">&quot;Revisión&quot;</span><span class="p">,</span> <span class="s2">&quot;Borrador&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;El comentario no puede estar vacío.&quot;</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;visualizar_contenido&quot;</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span></div>



<div class="viewcode-block" id="nromegusta">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.nromegusta">[documentos]</a>
<span class="k">def</span> <span class="nf">nromegusta</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aumenta el número de &quot;me gusta&quot; dado a un contenido específico.</span>

<span class="sd">    Esta vista recibe una solicitud HTTP y la clave primaria de un contenido para incrementar </span>
<span class="sd">    su contador de &quot;me gusta&quot;. </span>

<span class="sd">    :param request: El objeto de solicitud HTTP que contiene los datos de la petición.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :param pk: La clave primaria del contenido al cual se le va a incrementar el contador de &quot;me gusta&quot;.</span>
<span class="sd">    :type pk: int</span>
<span class="sd">    :return: Un objeto JsonResponse con el nuevo valor del contador de &quot;me gusta&quot;.</span>
<span class="sd">    :rtype: JsonResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contenido</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Contenido</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="c1"># Incrementar el contador de &quot;me gusta&quot;</span>
    <span class="n">contenido</span><span class="o">.</span><span class="n">megusta</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">contenido</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;me_gusta&quot;</span><span class="p">:</span> <span class="n">contenido</span><span class="o">.</span><span class="n">megusta</span><span class="p">})</span></div>



<div class="viewcode-block" id="reporte">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.reporte">[documentos]</a>
<span class="k">def</span> <span class="nf">reporte</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Genera un reporte filtrado de contenidos basados en parámetros como fecha, estado, </span>
<span class="sd">    categoría, y subcategoría. También calcula estadísticas como el total de visitas y &quot;me gusta&quot;.</span>

<span class="sd">    :param request: El objeto de solicitud HTTP que contiene los parámetros de la petición.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :return: Renderiza la plantilla &#39;reporte.html&#39; con los contenidos filtrados y el resumen calculado.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Obtener los parámetros de filtrado de la solicitud GET</span>
    <span class="n">fecha_inicio</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fecha_inicio&quot;</span><span class="p">)</span>
    <span class="n">fecha_fin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fecha_fin&quot;</span><span class="p">)</span>
    <span class="n">estado</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;estado&quot;</span><span class="p">)</span>

    <span class="n">categoria_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categoria&quot;</span><span class="p">)</span>
    <span class="n">subcategoria_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subcategoria&quot;</span><span class="p">)</span>

    <span class="c1"># Filtrar los contenidos según los parámetros</span>
    <span class="c1"># contenidos = Contenido.objects.order_by(&#39;-megusta&#39;)[:5]</span>
    <span class="n">contenidos</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">fecha_inicio</span><span class="p">:</span>
        <span class="n">fecha_inicio</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">fecha_inicio</span><span class="p">)</span>
        <span class="c1"># Ajustar la fecha de fin para incluir todo el día</span>
        <span class="n">fecha_inicio</span> <span class="o">=</span> <span class="n">make_aware</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">fecha_inicio</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">))</span>
        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">fecha_creacion__gte</span><span class="o">=</span><span class="n">fecha_inicio</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fecha_fin</span><span class="p">:</span>
        <span class="n">fecha_fin</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">fecha_fin</span><span class="p">)</span>
        <span class="c1"># Ajustar la fecha de fin para incluir todo el día</span>
        <span class="n">fecha_fin</span> <span class="o">=</span> <span class="n">make_aware</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">fecha_fin</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">))</span>
        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">fecha_creacion__lte</span><span class="o">=</span><span class="n">fecha_fin</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">estado</span><span class="p">:</span>
        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">estado</span><span class="o">=</span><span class="n">estado</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">categoria_id</span><span class="p">:</span>
        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">categoria_id</span><span class="o">=</span><span class="n">categoria_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">subcategoria_id</span><span class="p">:</span>
        <span class="n">contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">subcategoria_id</span><span class="o">=</span><span class="n">subcategoria_id</span><span class="p">)</span>

    <span class="c1"># Calcular el resumen general</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_visitas&quot;</span><span class="p">:</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">total_visitas</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;visualizaciones&quot;</span><span class="p">))[</span>
            <span class="s2">&quot;total_visitas&quot;</span>
        <span class="p">]</span>
        <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;total_megusta&quot;</span><span class="p">:</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">total_megusta</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;megusta&quot;</span><span class="p">))[</span>
            <span class="s2">&quot;total_megusta&quot;</span>
        <span class="p">]</span>
        <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;total_contenido&quot;</span><span class="p">:</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Calcular la cantidad de artículos redactados en el periodo de tiempo</span>
    <span class="n">articulos_redactados</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="c1"># Calcular el promedio de tiempo de revisión de artículos</span>
    <span class="n">tiempo_revision</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">fecha_inicio</span> <span class="ow">and</span> <span class="n">fecha_fin</span><span class="p">:</span>
        <span class="n">tiempo_revision</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">estado</span><span class="o">=</span><span class="s2">&quot;Revisión&quot;</span><span class="p">,</span>
                <span class="n">fecha_creacion__gte</span><span class="o">=</span><span class="n">fecha_inicio</span><span class="p">,</span>
                <span class="n">fecha_creacion__lte</span><span class="o">=</span><span class="n">fecha_fin</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">tiempo_revision</span><span class="o">=</span><span class="n">ExpressionWrapper</span><span class="p">(</span>
                    <span class="n">F</span><span class="p">(</span><span class="s2">&quot;fecha_modificacion&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;fecha_creacion&quot;</span><span class="p">),</span>
                    <span class="n">output_field</span><span class="o">=</span><span class="n">DurationField</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">promedio_tiempo_revision</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;tiempo_revision&quot;</span><span class="p">))[</span>
                <span class="s2">&quot;promedio_tiempo_revision&quot;</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Obtener los top 5 contenidos con más &quot;me gusta&quot;</span>
    <span class="n">top_contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-megusta&quot;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>

    <span class="c1"># Obtener los top 5 contenidos más leídos en el periodo de tiempo</span>
    <span class="k">if</span> <span class="n">fecha_inicio</span> <span class="ow">and</span> <span class="n">fecha_fin</span><span class="p">:</span>
        <span class="n">top_leidos</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">contenidos</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">visualizacion__fecha__range</span><span class="o">=</span><span class="p">(</span><span class="n">fecha_inicio</span><span class="p">,</span> <span class="n">fecha_fin</span><span class="p">))</span>
            <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">total_visitas</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;visualizacion__id&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-total_visitas&quot;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">top_leidos</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Obtener todas las categorías y subcategorías para los filtros</span>
    <span class="n">categorias</span> <span class="o">=</span> <span class="n">Categoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">subcategorias</span> <span class="o">=</span> <span class="n">Subcategoria</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;reporte.html&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;contenidos&quot;</span><span class="p">:</span> <span class="n">contenidos</span><span class="p">,</span>
            <span class="s2">&quot;top_contenidos&quot;</span><span class="p">:</span> <span class="n">top_contenidos</span><span class="p">,</span>
            <span class="s2">&quot;top_leidos&quot;</span><span class="p">:</span> <span class="n">top_leidos</span><span class="p">,</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
            <span class="s2">&quot;articulos_redactados&quot;</span><span class="p">:</span> <span class="n">articulos_redactados</span><span class="p">,</span>
            <span class="s2">&quot;tiempo_revision&quot;</span><span class="p">:</span> <span class="n">tiempo_revision</span><span class="p">,</span>
            <span class="s2">&quot;categorias&quot;</span><span class="p">:</span> <span class="n">categorias</span><span class="p">,</span>
            <span class="s2">&quot;subcategorias&quot;</span><span class="p">:</span> <span class="n">subcategorias</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span></div>


    <span class="c1"># return render(request, &#39;reporte.html&#39;, {</span>
    <span class="c1">#&#39;contenidos&#39;: contenidos.order_by(&#39;-megusta&#39;)[:5],</span>
    <span class="c1">#&#39;summary&#39;: summary,</span>
    <span class="c1"># })</span>
    <span class="c1"># return render(request, &#39;reporte.html&#39;, {&#39;contenidos&#39;: contenidos, &#39;summary&#39;: summary})</span>


<span class="c1"># Para impresion en pdf</span>


<div class="viewcode-block" id="generar_reporte_pdf">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.generar_reporte_pdf">[documentos]</a>
<span class="k">def</span> <span class="nf">generar_reporte_pdf</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Genera un reporte en formato PDF con un resumen de los contenidos, </span>
<span class="sd">    incluyendo el total de visitas, &quot;me gusta&quot; y un gráfico de los top 5 contenidos </span>
<span class="sd">    con más &quot;me gusta&quot;.</span>

<span class="sd">    :param request: El objeto de solicitud HTTP para la petición de generar el reporte en PDF.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :return: Un archivo PDF con el reporte generado.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_visitas&quot;</span><span class="p">:</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
            <span class="n">total_visitas</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;visualizaciones&quot;</span><span class="p">)</span>
        <span class="p">)[</span><span class="s2">&quot;total_visitas&quot;</span><span class="p">],</span>
        <span class="s2">&quot;total_megusta&quot;</span><span class="p">:</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">total_megusta</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;megusta&quot;</span><span class="p">))[</span>
            <span class="s2">&quot;total_megusta&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;total_contenido&quot;</span><span class="p">:</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># Crear la respuesta con tipo de contenido PDF</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/pdf&quot;</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Content-Disposition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=&quot;reporte_contenido.pdf&quot;&#39;</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="c1"># Escribir el contenido en el PDF</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="s2">&quot;Reporte de Contenidos&quot;</span><span class="p">)</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">730</span><span class="p">,</span> <span class="s2">&quot;Resumen General&quot;</span><span class="p">)</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">710</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Total de Visitas: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total_visitas&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">690</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Total de Me Gusta: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total_megusta&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">670</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Total de Contenidos: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total_contenido&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Obtener los contenidos</span>
    <span class="n">contenidos</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># Asegúrate de obtener todos los contenidos</span>

    <span class="c1"># Obtener los top 5 contenidos</span>
    <span class="n">top_contenidos</span> <span class="o">=</span> <span class="n">contenidos</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-megusta&quot;</span><span class="p">)[</span>
        <span class="p">:</span><span class="mi">5</span>
    <span class="p">]</span>  <span class="c1"># Filtrar los 5 contenidos con más &quot;me gusta&quot;</span>

    <span class="c1"># Crear el gráfico</span>
    <span class="n">titulos</span> <span class="o">=</span> <span class="p">[</span><span class="n">contenido</span><span class="o">.</span><span class="n">titulo</span> <span class="k">for</span> <span class="n">contenido</span> <span class="ow">in</span> <span class="n">top_contenidos</span><span class="p">]</span>
    <span class="n">megustas</span> <span class="o">=</span> <span class="p">[</span><span class="n">contenido</span><span class="o">.</span><span class="n">megusta</span> <span class="k">for</span> <span class="n">contenido</span> <span class="ow">in</span> <span class="n">top_contenidos</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">titulos</span><span class="p">,</span> <span class="n">megustas</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Top 5 Contenidos con Más Me Gusta&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Contenido&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Me Gusta&quot;</span><span class="p">)</span>

    <span class="c1"># Guardar el gráfico en un archivo temporal</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># Guardar como PNG en el archivo temporal</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">temp_file_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># Guardar la ruta del archivo temporal</span>

    <span class="c1"># Agregar el gráfico al PDF</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span>
        <span class="n">temp_file_path</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>  <span class="c1"># Ajusta la posición y el tamaño según sea necesario</span>

    <span class="c1"># Terminar el documento</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">showPage</span><span class="p">()</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># Eliminar el archivo temporal</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span></div>



<div class="viewcode-block" id="contar_visualizaciones">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.contar_visualizaciones">[documentos]</a>
<span class="k">def</span> <span class="nf">contar_visualizaciones</span><span class="p">(</span><span class="n">articulo_id</span><span class="p">,</span> <span class="n">inicio</span><span class="p">,</span> <span class="n">fin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cuenta el número de visualizaciones de un artículo en un rango de fechas determinado.</span>

<span class="sd">    :param articulo_id: El ID del artículo para el cual se van a contar las visualizaciones.</span>
<span class="sd">    :type articulo_id: int</span>
<span class="sd">    :param inicio: La fecha de inicio del rango en el que se contarán las visualizaciones.</span>
<span class="sd">    :type inicio: datetime</span>
<span class="sd">    :param fin: La fecha de fin del rango en el que se contarán las visualizaciones.</span>
<span class="sd">    :type fin: datetime</span>
<span class="sd">    :return: El número de visualizaciones del artículo en el rango de fechas especificado.</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Visualizacion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">articulo_id</span><span class="o">=</span><span class="n">articulo_id</span><span class="p">,</span> <span class="n">fecha__range</span><span class="o">=</span><span class="p">(</span><span class="n">inicio</span><span class="p">,</span> <span class="n">fin</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></div>



<div class="viewcode-block" id="graficar_visualizaciones">
<a class="viewcode-back" href="../../modulesf/contenidos/views_cont.html#contenidos.views_cont.graficar_visualizaciones">[documentos]</a>
<span class="k">def</span> <span class="nf">graficar_visualizaciones</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Genera un gráfico de visualizaciones por artículo dentro de un rango de fechas determinado.</span>

<span class="sd">    Esta función obtiene las fechas de inicio y fin del formulario enviado por el usuario</span>
<span class="sd">    (o usa un valor predeterminado de los últimos 30 días) y cuenta las visualizaciones de cada</span>
<span class="sd">    artículo en ese rango de fechas. Luego prepara los datos para mostrarlos en un gráfico.</span>

<span class="sd">    :param request: El objeto de solicitud HTTP que contiene los parámetros de fecha y las peticiones de datos.</span>
<span class="sd">    :type request: HttpRequest</span>
<span class="sd">    :return: Una respuesta que renderiza una plantilla con los datos de visualizaciones y el gráfico.</span>
<span class="sd">    :rtype: HttpResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fin</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">inicio</span> <span class="o">=</span> <span class="n">fin</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># Valor por defecto de 30 días atrás</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># Obtener las fechas del formulario</span>
        <span class="n">inicio</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fecha_inicio&quot;</span><span class="p">)</span>
        <span class="n">fin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fecha_fin&quot;</span><span class="p">)</span>

        <span class="c1"># Convertir las fechas a objetos datetime</span>
        <span class="n">inicio</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">inicio</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fin</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Contar visualizaciones por artículo en el rango de fechas</span>
    <span class="n">contenidos</span> <span class="o">=</span> <span class="n">Contenido</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">datos_visualizaciones</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">contenido</span><span class="o">.</span><span class="n">titulo</span><span class="p">:</span> <span class="n">Visualizacion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">contenido</span><span class="o">=</span><span class="n">contenido</span><span class="p">,</span> <span class="n">fecha__range</span><span class="o">=</span><span class="p">(</span><span class="n">inicio</span><span class="p">,</span> <span class="n">fin</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">contenido</span> <span class="ow">in</span> <span class="n">contenidos</span>
    <span class="p">}</span>

    <span class="c1"># Preparar datos para el gráfico</span>
    <span class="n">titulos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">datos_visualizaciones</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">conteos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">datos_visualizaciones</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;graficar_visualizaciones.html&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;titulos&quot;</span><span class="p">:</span> <span class="n">titulos</span><span class="p">,</span>
            <span class="s2">&quot;conteos&quot;</span><span class="p">:</span> <span class="n">conteos</span><span class="p">,</span>
            <span class="s2">&quot;fecha_inicio&quot;</span><span class="p">:</span> <span class="n">inicio</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
            <span class="s2">&quot;fecha_fin&quot;</span><span class="p">:</span> <span class="n">fin</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
        <span class="p">},</span>
    <span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Índice de Módulos Python"
             >módulos</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">documentación de cmsweb - 0.1</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Código de módulo</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">contenidos.views_cont</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, equipo01.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>